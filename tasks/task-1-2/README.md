# Задание 1.1

> По заданию просят нарисовать все на общей диаграммме,
> но получается слишком сложная схема. На сколько я понимаю C4 рекомендуется раскрывать от общего к частному.
> Потому разделил схему на 1 общую (1 уровня) и 2 второго уровня

- **[System Context-Diagram](system-context-diagram.puml)**  
  Общая краткая диаграмма будущей системы.

- **[IoT Hub Container Diagram](iot-hub-container-diagram.puml)**  
  Диаграмма раскрывающая модуль IoT Hub в связке с устройствами в доме.

- **[Portal Container Diagram](portal-container-diagram.puml)**  
  Диаграмма раскрывающая основной модуль бакенда умного дома.

- **Components Diagram**
  Пропустил тк уже много диаграм вышло.

- **[ER Diagram](er-diagram.puml)**  
  Диаграмма баз данных.

Ниже расшифровка по составляющим.

## Hardware/устройства

В задани не упоминается на какой технической базе реализованы устройства.
Но если у бизнеса есть требование гибко добавлять новые устройства в систему,
то будем стараться рассматривать типовые, популярные решения, например:

- Основной протокло коммуникации между устройством и сервером - **MQTT**
- Все устройства используют единое SDK для управления и коммуникации
  (например сертифицированы для работы с тем или иным IoT хабом)
- Типовой механизм подключения (через Bluetooth или Wi-Fi точку доступа)
- Сами устройства могут подключаться к интернет через Wi-Fi или сотовую связь
- Сенсоры подключать к устройству/gateway через сеть Zigbee или Bluetooth

### IoT Hub в Cloud

Задание предполагает, что готовых решений мы не используем.
Однако в реальном проекте есть смысл рассмотреть существующие IoT платформы
чтобы сосредоточиться на своей бизнес логике

- Есть такие Cloud-решения как Azure IoT Hub, [AWS IoT](https://aws.amazon.com/iot/), в РФ аналогичный сервис
  предоставляет [Yandex IoT](https://yandex.cloud/en/services/iot-core?).
- Если требование не использовать Saas, то можно поискать Hosted/OpenSource решения.

## Микросервисы бакенд-платформы

### IoT Hub

Базовый функционал IoT хаба (если реализуется самостоятельно in-house).

- **Device Provisioning Service**   
  Первичная регистрация устройств в хабе, аутентификация и безопасность (отправка сертификата), привязывает
  устройство к хабу, выдает данные для подключения.
- **Device Core Management Service:**  
  Обновляет и хранит последнее состояние, мета-информацию, конфигурацию, позволяет обновить версию Firmware.
  Сервис не знает детали о типе устройства (хранит и обновляет их параметры абстрактно в виде JSON).
- **Communication Service**  
  Обеспечивает канал связи между устройствами и хабом преимущественно через **MQTT** протокол.
  Предоставляет набор топиков для обмена данными и командами, муршрутизирует сообщения.
  Может быть реализован на базе **Apache Kafka**.

### SmartHome portal

Основная платформа «Тёплый дом»

- **Data Processing Service**  
  Сервис обработки и хранения телеметрии. Принимает потоки данных от устройств (из MQTT топиков Kafka), обрабатывает
  складирует в Timeseries базу (Clickhouse). Может генерировать дополнительные события в ходе обработки.
  Предоставляет HTTP API доступа к данным и аггрегатам для аналитики и UI
- **Device Configuration Service**
  Этот сервис уже непосредственно знает детали о типе усторойства, его параметрах, сенсорах, командах,
  обогощает/преобразует сырые данные состояния из Device Core Service,
  хранит дополнительные настройки (например расписания действий), предоставляет верхнеуровневые HTTP API для портала.
- **User Management Service**   
  Отвечает за регистрацию пользователей, настройки аккаунта, хранит сущности 'Дом' (location)
  пользователя к которому привязываются устройства и таким образом разделяются права доступа.
- **Notification Service**
  Отправляет уведомления и оповещения пользователю, через push-уведомления, email и SMS.
- **Support BFF**  
  Бакенд API для внутренних UI дашбордов техподдержки, техников, аналитиков.
- **User Portal BFF**  
  Бакенд API для кабинета пользователей (Web UI и мобильных приложений).
  Реализует API которые сложно напрямую через API-Gateway направлять от UI в сервисы.
- **Keycloak - Auth Service**   
  Сервис аутентификации и авторизации пользователей (внешних и внутренних).
- **API Gateway**  
  Авторизует внешние API-запросы через Keycloak сервис (от систем и пользователей),
  маршрутизирует запросы к сервисам.

### Infrastructure

Общие внутренние инструменты и сервисы.

- **Kubernetes**  
  Оркестрация контейнеров микросервисов, балансировка нагрузки через него же.
  Все сервисы stateless и запущены по крайней мере в 3х репликах.
  K8s отвечает за Service Registry и Discovery. У каждого сервиса свой хост для HTTP-запросов.
- **Apache Kafka**  
  Шина данных. Основной поток данных с устройств через MQTT и внутреняя шина обмена данными между сервисами.
- **Redis cache** - Общий слой кеша в k8s для всех сервисов.
- **Prometheus**  
  Сервис для хранения метрик мониторинга
- **Grafana**  
  Шаброрды мониторинка, алертинг, Loki для логов
- **Zipkin**
  В связке с Spring boot позволяет настроить трассировку, также может быть интегрирован и с Kafka.
  Что позволит отследить путь сообщения по deviceID между сервисами до устройства и обратно.
- **Базы данных:**
    - MongoDb - для хранения основных данных во всех сервисах, у каждого сервиса своя база.
      подходит лучше чем SQL тк набор полей у устройств очень разный и нужна гибкость.
    - Clickhouse - для хранения Timeseries данных (телеметрии, логи с устройств).
- **Gitlab**
  Хранение кода, CI/CD