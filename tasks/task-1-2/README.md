# Задание 1.1

[Context-Diagram](v2-container-diagram.puml) -
Диаграмма уровня контейнеров новой архитектуры.

### IoT Hub (свое решение или готовое)

Задание предполагает, что готовых решений мы не используем. Однако в IoT важно не изобретать велосипед, а использовать
существующие системы, протоколы и подходы:

- Для управления устройствами есть системы, такие как Azure IoT Hub, [AWS IoT](https://aws.amazon.com/iot/),
  в РФ аналогичный сервис предоставляет [Yandex IoT](https://yandex.cloud/en/services/iot-core?).
- Также скорее всего есть и on-premise решения и прочие Saas, облегчающие подключение и менеджент устройств
- Поэтому стоит использовать готовые решения для Core-логики, сосредоточившись на бизнес-логике и специфике своих
  устройств.
- Если все делаем in-house, полезно ориентироваться на существующие примеры; предположим, что IoT Hub у нас свой.

## Hardware-часть

В задани не упоминается типы устройств, протоколов, типа инсталяции.
Предположу такую топологию:

- Автономные сенсоры/датчики подключаются к единому шлюзу (**Gateway**) или другим устройствам, через радио-сеть
  **Zigbee** или прямым проводным подключением.
- IP-камера, система отопления - это самостоятельные устройства.
- Gateway и другие устройства непосредственно подключаются к интернет (через WiFi или сотовую сеть)
- У одного устройства/модуля может быть несколько сенсоров и других параметров телеметрии
- Устройство регистрируется в IoT хабе, передает на него телеметрию и управляется через него
- Основной протокло коммуникации **MQTT**
- Все устройства, которые мы продаем имеют одинаковые SDK для подключения к хабу,
  поддерживают популярные протоколы и механизмы подключения (например Bluetooth + Wifi)

## Микросервисы бакенд-платформы

### IoT Hub

Базовый функционал IoT хаба.

- **Device Provisioning Service**   
  Первичная регистрация устройств в хабе, аутентификация и безопасность (отправка сертификата), привязывает
  устройство к хабу, выдает данные для подключения.
- **Device Management Service:**  
  Информация об устройствах: последнее состояние, мета-информация, конфигурация, логи, обновление прошивки (firmware).
  Сервис не знает о типе устройства и наборе его параметров (хранит и обновляет их абстрактно).
- **Communication Service**  
  Обеспечивает канал связи между устройствами и хабом преимущественно через **MQTT** протокол.
  Предоставляет набор топиков для обмена данными и командами. Работает на базе **Apache Kafka**.

### SmartHome portal

Основная платформа «Тёплый дом»

- **Data Service**  
  Сервис обработки и хранения телеметрии. Принимает потоки данных от устройств (из топиков Kafka), обрабатывает
  складирует в Timeseries базу (Clickhouse). Предоставляет HTTP API доступа к данным и аггрегатам для аналитики и UI
- **Device Configuration Service**
  Этот сервис уже непосредственно знает о типе усторойства, его параметрах, командах
  и предоставляет верхнеуровневые HTTP API для портала. Хранит каталог моделей продаваемых устройств,
  хранит Activity Log (историю изменений конфигураций).
- **User Management Service**   
  Сервис управления пользователями: Отвечает за регистрацию пользователей, настройки аккаунта,
  настройку прав доступа к устройствам, привязку к сущности 'Дом'/'Комната'.
- **Notification Service**
  Отправляет уведомления и оповещения пользователю, через push-уведомления, email и SMS.
- **Support BFF**  
  Бакенд внутренней платформы для техподдержки, техников, аналитиков.
- **User Portal BFF**  
  Бакенд портала пользователей пока общий для Web и мобильных приложений.
  Различная логика общая, которая не укладывается в рамки выделенных сервисов.
- **Keycloak - Auth Service**   
  Сервис аутентификации и авторизации пользователей (внешних и внутренних),
  пользовательская авторизация через Google/Facebook, номер телефона.
- **API Gateway**  
  Авторизует внешние API-запросы через Keycloak сервис (от систем и пользователей),
  маршрутизирует запросы между сервисами.

### Infrastructure

Общие внутренние инструменты и сервисы.

- **Kubernetes**  
  Оркестрация контейнеров микросервисов, балансировка нагрузки через него же.
  Все сервисы stateless и запущены по крайней мере в 3х репликах.
  K8s отвечает за Service Registry и Discovery. У каждого сервиса свой хост для HTTP-запросов.
- **Apache Kafka**  
  Шина данных. Основной поток данных с устройств через MQTT и внутреняя шина обмена данными между сервисами.
- **Redis cache** - Общий слой кеша в k8s для всех сервисов.
- **Prometheus**  
  Сервис для хранения метрик мониторинга
- **Grafana**  
  Шаброрды мониторинка, алертинг, Loki для логов
- **Zipkin**
  В связке с Spring boot позволяет настроить трассировку, также может быть интегрирован и с Kafka.
  Что позволит отследить путь сообщения по deviceID между сервисами до устройства и обратно.
- **Базы данных:**
    - MongoDb - для хранения основных данных во всех сервисах, у каждого сервиса своя база.
      подходит лучше чем SQL тк набор полей у устройств очень разный и нужна гибкость.
    - Clickhouse - для хранения Timeseries данных (телеметрии, логи с устройств).
- **Gitlab**
  Хранение кода, CI/CD