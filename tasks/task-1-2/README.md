# Задание 1.1

> По заданию просят нарисовать все на общей диаграммме,
> но получается слишком сложная схема. На сколько я понимаю C4 рекомендуется раскрывать от общего к частному.
> Потому разделил схему на 1 общую (1 уровня) и 2 второго уровня

- **[System Context-Diagram](system-context-diagram.puml)** |
  [SVG](https://plantuml.etservice.net/svg/jLHHQnj747xNhzZewGIo3qeVIjzaIqs2erIr50gbO5QdbMxHtUwnjnV7b4BiD6s2Iq9BeKzj8NtiY-hOjHBPCkGNxFwZpjoUJhBYLqiSTpixEzytiz_C7Iw2A1im4cgTf9_xlgBxcoEkmwoVfKm5KcWcz6OWOp-9gD1P76saUX3nlh_zwKO7JO_Q3_oOffefCErjuuadUZC1pygTsuXEkM3grkB7YHHuvdRYDraIoOEu1AXKjcGc1bGTU3JGKgLrKgtMo7SL0hyEKwaK7YA1sVnbvcPcVpRdy3un4tjapd1ThQqwfrcIIAKN_gVmFxDFpN_clPbSzzGi2D7j3JWyDvTcQjuN3cMHFPeaoEXhrYS-QSi-ZnZvLf16aaGye9fBaLPXdt_PzHjYe2GV-E1RpPEeV5-fT0yWyNYlzKHxe0cc18swJ3tc0SEmhS945ZOyQ7wrX-OAg5_0ytQPfhcqn-QCm2RcSsAczj0U4--kbAE8-SY8rKcttQsJLanvL0C2A-W9LHeISXR4xZZ3DUYjJxO8bE4oXtmBA1Fx8wod46fvJN3FUYXL3FuV_Z5lx2z0TWRKtX4eDR3-C2FUVTaZKFuPihS_c3c4kZ2J6cAqG34gKJnbv27J-rADwsJdCs1qhzVha4RdFYpfS4n9JoOyI4ijEEOUb_fUreSu205Vr_Xla2R31Uae-PYdS3jSZF2-oerjgHXfKq5733Neza3pSIQA-omaKC2Xb6Y4vSe_RaPhKaqH4kpfnu1Yo4UPocExdKSWvuyuD38TBg8xIzS9UM4iU2txP--X732FYw6YM0vyfrfbWSuWnLMUEraVLCOqInSLT-mR2Gr2vggDYBjim5EodHjp1f1Ip7J8ChYTkueEWRBR-8OdOoxgv84SSwVpKXqX744H_vOBU69VW9fUszTEjaVGhDXDVECBNeSeepu3vwqeOrfA7QxTTQxR4TLidnx0ALTGro9_W_QFG5Hpymw_S1eG-mm0B_EUcHTID9CwGHMRVq62Hy3cbNq9UeOc-YbleZDpJe3XpBuovvuzhg7uPsPASk_JHTkP-QPBSfT5nImgnW81EnhBcRDcTnDcpUYMfR1sMzqUoXxpmXQuvhNCtlm1zCkaSPX1mZTLOPdPIbtpa0l86mOHuFlTvix2SMrMb5pDxr3BAqIqXrZY2HG7ff9zlWgBiM06XbAErt8giocRsFm9jA_oApfnEUN33fwBN2vFSVhKIUuoXKbpGS0hlrX0FgsJPWSXsb_rUWNz_m40)  
  Общая краткая диаграмма будущей системы.


- **[IoT Hub Container Diagram](iot-hub-container-diagram.puml)** |
  [SVG](https://plantuml.etservice.net/svg/lLPTQnj757tVNp5H-o21R3N651pgW2sbTL8vLYk5q58Gizh9QibgH-oEd8XIi6EtQN6e2VIn9FruAVH5iRru4raov1VC_AFUExlQbIsvzCNrWxrpvtwSkVVC6Tzml9RRinXf2z4DRfLAFdsoQ3kYtJDx0VDRt1FC4uijtYbrNUg9NiTT28JbEcQflBnGGzE3pMgfGmF1V30ronZnL2nsmTEuSHtPgUCn_zhoTxhSmvZhoLzXNPVtEsa1OysolcHkWzhvd4M3DhDoHVAX2oUiYxxBo2gfQ6iLBFb20Ttlk0pZun0JtKsxp5tkh-O-M5bPCQsRsiPzY_aJ-t9h-MFperp1CAfhNsqzQ3GRMxLcPUlX_JoOX2EWalnLZkM9sfD3zOBSvGsoqJE9Z8WyagTo82DvXliob6_Lhde6raY6HEqIjOThjGExavq1-4Qm0Nz6O3wMOmAHOrWE3AF6_81xUMnVaUJaQx13HQWnnaY83t7zZKSskUa0Bjhj8kvrtlCiwlVpRTvX6FXBd53zA4VgK1q251a2ZXTm-Dn3P-5JfqY-TcoJWVEwssE2Sz7E5SYt1e6VTCpDEqz5Fc1UmFsR45ZNNmGxc8kZeNOSaF1E1zXKi2Uq3quLjksq6FaiDipKJgDdoorbvPPcokbVLTflLZFlfEWyF6r6XUFPzJxGh0EvDk8rYGqfAloGlyj8Zod4xX4vXi-nF9T3C8nWwt3kWLt7RcD6I51DFYzc_HCIHEgvddU8MNTXcg7wASugm-bp9UqcYxSdPveoBqsRlpCCk1m9LoQ3Vwrv-0vOyZCKJFBFfI71VJ25yZJZG2a6FKqfXmiWE-HEQ9zBFilSPqJj0v57yftw0Uf4AOEoYzoyposMVqmVFQO8xozm6s5dJ-0UZ82S1-fxJBZMfQqs8v-Z7wutlsWqIDBy28uJNMvytke66SDgFjzs0eTxIUllqMsT1jg1HpnAkZ_0cu0dFex73Dy3H8xcEHsQhQchRLAFsbfbwin7GuP3zoJRlm3b9PnOtsDre4aWtm01S3ZO4gISsb7xYO8S8Co1V8C4nCKkmTK4ChJx6RPEdis33HT_SGOvQ72dvpajO3xtCjZbQJD9x1TGlm8G8V3r77u_1wIeNw0a16Q20np88MhBaJg4iqN_hdWPtN2wfOr6erQ_3BHY9aqEAcRMrhe0ofFAkcO6zsmUVu8e0nHa4tPm7vgreqLFJxI8kCOQmHZGwNjGHDXZxHl9Oq2QpXyV1K7jODKo2tYnKlPtkI-e2yNU_ot_K2zH2w3nRnF9VZyaDUqmfPqfMQYWCmIfW17P2WSCPhWAS29K7lsm83zI3c2tIQp-Mff2tU5ephM0H_UHO_VyIuEUyBCN2Dv1zypf0eRV8Fq0rKgUmiNMWnxgHmekeTg3vuxezmulr6xywkaEHreg4M447HhCyk__QaQYYR4QNa5w-Gg2ptM-eojp0LNG9OAHdyMiETE4FocIIcsYK367IRvHhHUW-1NoG1PkavJK1kWM-GGiMXBrAjsUZRn5i09PgzqrjB-Ed7SiF7MpCj7PgtLAt-UH_czYcBqEbowAVkRYUWi8BfiT04fUc7FD0EoUrlDCghK6p3OKTCsOnyt_UFf_0000)  
  Диаграмма раскрывающая модуль IoT Hub в связке с устройствами в доме.


- **[Portal Container Diagram](portal-container-diagram.puml)** |
  [SVG](https://plantuml.etservice.net/svg/jLRFRnD75BxdhnZS7X8fiLi9LGeYaPmuQO24ciHHBvMYjNTYhxBUMUsk0Qj2Wa1QLQc4kFNIGZbLwcK3IJ5EOYJ-Wjd_gD-R7NjtdLqu0PApy-PxytvzxyrSivoMtJCvwmI1wz-eL3pZGRbj1PrUi-TphoMSW3j1kIMw5TSsdA3NjHVymBIjPcNr-aATHBjRcvMkuGVSWsXlbJGU1cKNo9bhN-9qmtAuzyNExxh28PqlStwDkxReToS6ggQvpUs6qPujcORVuMPfddrj8y2Te6zpjiHgIhe9oUpS7C7NR4xgiKgJuCtsgh25jrJwQd5niMb-gsJ2CxatbbzlNV-k-KrfRcOci08SAr_8SpcIGnOzaMVHO_b63l0rac-O7E7ZaZxLxrivOl83X8-ZGnb2AMJHKtcHx9tYuqA6CpChekUOXjUVDLg1yFnvLYhDiPzd6FxLkUSBPvOI1h5y2PNpw7VvJba9SV0PhU5T2kptN5TumHX_Yl_aw7zoACCiCk2j3i5U0t04nmPog04JhimQhaiU_SYRhCAsHDD23dvoMDLrRQjb19PmV2IjPFsmKwawfYSiim9iIGMXZaADjF_wA9RQcFYQinTxbzfub4gL9OADNXCRjqI3uQkaFrU5nrdq39c-bCFe5uGqc2Gp8T3UNM7osGDZ_y2W-Fy1x1BrGQP2V5n6nz4H7LXrZLQ7ipk4e_NMlKQ38UaZr1MvegEdicNo-rQBRncEqLPKs-4U2Q1RKpknVya-dNhRkAzE1xF2kBBHiJm3dUH9z1liu1FkKQr1fMUe-FleINJCKD9Gde1VXxHumcY5ZKCb7mAECEG5EAU58wLt2Dw0TcNjUO6_xEO2Kzd9vDprnCC-75rp0g_FN671_t5kKuJf1Pqax2fMJ2yfo3kytxA5SP33C-jx8-0F3B9GhTzYUgMKXDFM2WcCBIopbAsif-2KOKFpux_oTVG2vJf7CjxhdljupkeAKCWCZviMiMwR_h9LOa5flAHHG3eJOwOH6Dg9lNJlJZ4ZGILig478wfveST-t46EQ3IzHCnGV9PI3c0oJWbCdixZv2G1Y72hmc8yPoxMcibsZPb7sQYjq_YhQzs13e3DfrR2w7DvPt6SmGJGCYLCvDa0_jNE5LZGw0wFjBvdDn0lqyLuj6_l4cPrxcvNRzQhs-T5KLcba9BpyH6ApGE1s8IXgiLVm_orDxBXFQ414pzMOlZfNATHvHeCX2PMQdZfjI2MW8KEplI3hv9WAb1poTTgtG6LHQvOAfxaSmEOVqH7R45rUsHQYY_NVc0dFWIFhCNKMbcd_4pcVJil46rQGS5p8-rQxvwcP_da-vy5JOwxd1w9By0IKASHVn6Iw1p7YGY8Nelo079zDcFuEwOKyDPJrKCmRQMVpJ2dJFJj8LC-L3Opgw2cZ6ngqrXVs09GUAMLgBc3f2pm8omNLZEDL6OoZoYdeAw8AtGtu9P_1hJm2GJPKvGvZ1ndvGhTqpBbF53K_wIdNfegRbCiHWRMlB-oaMdTJqlIKLcMQddChw-l5TD0NUOpPYHSCgzHf-QqRJ-9OJtLkBCZHrJ5j6draGYbCpOYvwVtqPBwocSltSSphwtIzPCzdDzX6er5dk9pIeBnp2g0fVz881L7NBIilivnAfH4touKczPLngSWTnXqmA6ehzMWzmKldC1w1MEZ7Av5GSPUf_W1HgU7G6Kd-DtFvb2bddEySsDN4mlC_hmnPk8csrezaxHBDuthFxyHli249esEw-AaxTWkwe_X9fWVmq-XNVVoPoegAUeHvgqJpQZoe9DBie9iNF-hb3i0fSNHSIF1qKiLigSbIx7FcZPbxXrCm-jMTUHDjh-qqb1Lj4TPYP8APxYUMWyaqAW7-1m00)  
  Диаграмма раскрывающая основной модуль бакенда умного дома.


- **Components Diagram**  
  Пропустил тк уже много диаграм вышло.


- **[ER Diagram](er-diagram.puml)** |
  [SVG](https://plantuml.etservice.net/svg/bLNRZjem47tdAwnzN9MkzZLQ8Uqkj4krGDM5vyWa0x5mxDHsMD7I7-jNz9CwCRaGRDZ04vev6S-SESVEQBIXQo0tOpadB_cIt94XR5a4v5ag8CEd6_AxroFu0s6OsP7OPZL6IVcx9Imc0LainiCwrk_NVpKeHdaeydG92d5lyn_ZwTSwRNOPO7GqNKpgM2fZu2uqeIf-fmh2BIZDf700D3T9k86TauWKK0DnI4sxwf-UPxPG6mIt1YmJ5-TaEfI2Cm41UPhDNaUFqpgrOYgzs7WCcgdgu81yUvir7tEgZJ-JPt4vLK26Z_FHV3mPLMCTgZRZ144pmtxVt--hHGQ1dUgU_FjBxdluPLOfuhjKXd8Kn09NI2PKO3H5fafH7F6M8-0AHK1AcMUzMI85k651Kq-KHePjuR3GrkpEkdtCb7qdChr6oMudxN853Q5RquRTmhVs-8yrzIv0jINb3X7wN7bMj5rEVdZ81VkPms3GrFbKVUVf8fLBnZ4dK6sSKuCgzp1xiiIpt1mrac6nbLJfoHL1i-oicx9S9w6H6t1J7rdccCmWg6Z2VWO7iHHkiS1crvrXrQmMPYrJmtpiDH-qyLwBrdUsMB5rhcm5rwVLXH0b4EUygroEbb6u3WkVx4911WMXhM31is4fUEnPX7_9ug9qhNJQAXZ3nFhwJWklkc-Dxs2h6AfegZlVhzYiTmlFd4MR5ucxEikz0OwNg56xgoUg2dZUImr2IsLJxjDoVWzRodECVtcTFSuzbYuFv79zTQySjlO1xwe8z8T6Ajkz58zpsu_DqUHpVt3yWlLEwUq2nicwm6gxT0ANWhs8_Gy0)   
  Диаграмма баз данных.

Ниже расшифровка по составляющим.

## Hardware/устройства

В задани не упоминается на какой технической базе реализованы устройства.
Но если у бизнеса есть требование гибко добавлять новые устройства в систему,
то будем стараться рассматривать типовые, популярные решения, например:

- Основной протокол коммуникации между устройством и сервером - **MQTT**
- Все устройства используют единое SDK для управления и коммуникации
  (например сертифицированы для работы с тем или иным IoT хабом)
- Типовой механизм подключения (через Bluetooth или Wi-Fi точку доступа)
- Сами устройства могут подключаться к интернет через Wi-Fi или сотовую связь
- Сенсоры подключать к устройству/gateway через сеть Zigbee или Bluetooth

### IoT Hub в Cloud

Задание предполагает, что готовых решений мы не используем.
Однако в реальном проекте есть смысл рассмотреть существующие IoT платформы
чтобы сосредоточиться на своей бизнес логике

- Есть такие Cloud-решения как Azure IoT Hub, [AWS IoT](https://aws.amazon.com/iot/), в РФ аналогичный сервис
  предоставляет [Yandex IoT](https://yandex.cloud/en/services/iot-core?).
- Если требование не использовать Saas, то можно поискать Hosted/OpenSource решения.

## Микросервисы бакенд-платформы

### IoT Hub

Базовый функционал IoT хаба (если реализуется самостоятельно in-house).

- **Device Provisioning Service**   
  Первичная регистрация устройств в хабе, аутентификация и безопасность (отправка сертификата), привязывает
  устройство к хабу, выдает данные для подключения.
- **Device Core Management Service:**  
  Обновляет и хранит последнее состояние, мета-информацию, конфигурацию, позволяет обновить версию Firmware.
  Сервис не знает детали о типе устройства (хранит и обновляет их параметры абстрактно в виде JSON).
- **Communication Service**  
  Обеспечивает канал связи между устройствами и хабом преимущественно через **MQTT** протокол.
  Предоставляет набор топиков для обмена данными и командами, муршрутизирует сообщения.

### SmartHome portal

Основная платформа «Тёплый дом»

- **Data Processing Service**  
  Сервис обработки и хранения телеметрии. Принимает потоки данных от устройств (из MQTT топиков), обрабатывает
  складирует в Timeseries базу (Clickhouse). Может генерировать дополнительные события в ходе обработки.
  Предоставляет HTTP API доступа к данным и аггрегатам для аналитики и UI
- **Device Configuration Service**
  Этот сервис уже непосредственно знает детали о типе усторойства, его параметрах, сенсорах, командах,
  обогощает/преобразует сырые данные состояния из Device Core Service,
  хранит дополнительные настройки (например расписания действий), предоставляет верхнеуровневые HTTP API для портала.
- **User Management Service**   
  Отвечает за регистрацию пользователей, настройки аккаунта, хранит сущности 'Дом' (location)
  пользователя к которому привязываются устройства и таким образом разделяются права доступа.
- **Notification Service**
  Отправляет уведомления и оповещения пользователю, через push-уведомления, email и SMS.
- **Support BFF**  
  Бакенд API для внутренних UI дашбордов техподдержки, техников, аналитиков.
- **User Portal BFF**  
  Бакенд API для кабинета пользователей (Web UI и мобильных приложений).
  Реализует API которые сложно напрямую через API-Gateway направлять от UI в сервисы.
- **Keycloak - Auth Service**   
  Сервис аутентификации и авторизации пользователей (внешних и внутренних).
- **API Gateway**  
  Авторизует внешние API-запросы через Keycloak сервис (от систем и пользователей),
  маршрутизирует запросы к сервисам.

### Infrastructure

Общие внутренние инструменты и сервисы.

- **Kubernetes**  
  Оркестрация контейнеров микросервисов, балансировка нагрузки через него же.
  Все сервисы stateless и запущены по крайней мере в 3х репликах.
  K8s отвечает за Service Registry и Discovery. У каждого сервиса свой хост для HTTP-запросов.
- **Mosquitto**  
  Mosquitto — легковесный брокер MQTT, который используется для надежной передачи сообщений между устройствами и
  IoT-хабом интернет.
- **Apache Kafka**  
  Может работать в связке с Moskuitto/MQTT - обрабатывает данные на уровне инфраструктуры.
  Но можно на каком-то этапе ограничиться только MQTT топиками.
- **Redis cache** - Общий слой кеша в k8s для всех сервисов.
- **Prometheus**  
  Сервис для хранения метрик мониторинга
- **Grafana**  
  Шаброрды мониторинка, алертинг, Loki для логов
- **Zipkin**
  В связке с Spring boot позволяет настроить трассировку, также может быть интегрирован и с Kafka.
  Что позволит отследить путь сообщения по deviceID между сервисами до устройства и обратно.
- **Базы данных:**
    - MongoDb - для хранения основных данных во всех сервисах, у каждого сервиса своя база.
      подходит лучше чем SQL тк набор полей у устройств очень разный и нужна гибкость.
    - Clickhouse - для хранения Timeseries данных (телеметрии, логи с устройств).
- **Gitlab**
  Хранение кода, CI/CD